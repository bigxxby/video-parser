services:
  video-parser:
    build: .
    container_name: video-parser
    # Note: network_mode: host doesn't work on macOS, using default bridge
    
    environment:
      - NODE_ENV=production
      - DOCKER_MODE=true
      - BATCH_MODE=true # Enable batch processing of wins.json by default
      # Chrome path in ARM64 Debian image
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
      # Software rendering (Mac не поддерживает GPU passthrough в Docker)
      - LIBGL_ALWAYS_SOFTWARE=1
    
    volumes:
      # Mount recordings directory
      - ./recordings:/app/recordings
      # Mount source for development
      - ./pragmatic_play_wins.json:/app/pragmatic_play_wins.json:ro
    
    # Shared memory for Chrome (важно для стабильности)
    shm_size: '2gb'
    
    # Security options for Chrome
    security_opt:
      - seccomp:unconfined

# =================================================
# Для Linux с NVIDIA GPU раскомментируйте ниже:
# =================================================
#   deploy:
#     resources:
#       reservations:
#         devices:
#           - driver: nvidia
#             count: all
#             capabilities: [gpu, video, compute, utility]
#   environment:
#     - NVIDIA_VISIBLE_DEVICES=all
#     - NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics,video

services:
  video-parser:
    build: .
    container_name: video-parser
    
    shm_size: '16gb'
    
    cap_add:
      - SYS_NICE
    
    # Resource limits - выделяем максимум ресурсов
    deploy:
      resources:
        limits:
          cpus: '8'        # 8 CPU cores
          memory: 16G      # 16GB RAM
        reservations:
          cpus: '4'        # минимум 4 CPU гарантировано
          memory: 8G       # минимум 8GB RAM гарантировано
    
    environment:
      - NODE_ENV=production
      - DOCKER_MODE=true
      - BATCH_MODE=true
      # Chrome path
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
      # Software rendering for Mac (no GPU passthrough)
      - LIBGL_ALWAYS_SOFTWARE=1
      # Reduce Chrome memory pressure
      - CHROME_DISABLE_GPU_COMPOSITING=1
    
    volumes:
      # Mount recordings directory
      - ./recordings:/app/recordings
      # Mount source for development
      - ./pragmatic_play_wins.json:/app/pragmatic_play_wins.json:ro
    
    # Security options for Chrome
    security_opt:
      - seccomp:unconfined

# =================================================
# Для Linux с NVIDIA GPU используйте:
# docker compose -f docker-compose.yml -f docker-compose.gpu.yml up
# =================================================
